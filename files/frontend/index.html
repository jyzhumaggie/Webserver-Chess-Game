<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"> 
    <title>Chessboard</title>
    <style>
        .chessboard {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 400px;
            height: 400px;
        }

        .chessboard div {
            border: 1px solid black;
            cursor: pointer;
        }

		.checker-dark {
			background-color: rgba(34, 49, 4, 0.901);
		}
		.checker-light {
			background-color: rgba(89, 99, 69, 0.861);
		}

        .piece {
            font-size: 40px;
            text-align: center;
            line-height: 1;
        }

        .highlight {
            background-color: rgba(155, 179, 109, 0.816) !important;
        }
    </style>
</head>


<body>
	<!-- Start New Game button -->
	<button type="button" id="myButton">Start New Game</button>
	<!-- Chessboard Display -->
    <div class="chessboard"></div>

	<script>
		var btn = document.getElementById('myButton');

		btn.addEventListener('click', function() {
			fetch('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR')
				.then(response => response.text())
				.then(data => {
					console.log(data);
					// Initialize board using response data (board)
					var pieces = getUnicodeFromBoard(data);
					
					// Creating checkered board
					const chessboard = document.querySelector('.chessboard');
					while (chessboard.firstChild) {
						chessboard.firstChild.remove();
						console.log(`Starting new game, cleared Chessboard`);
					}
					var checker = true;
					for (let row = 0; row < 8; row++) {
						for (let col = 0; col < 8; col++) {
							const square = document.createElement('div');
							if (col == 0) {
								checker = !checker;
							}
							if (checker) {
								square.classList.add('checker-dark');
							} else {
								square.classList.add('checker-light');
							}
							square.classList.add('piece');
							square.innerHTML = pieces[row * 8 + col];
							chessboard.appendChild(square);
							square.addEventListener('click', handlePieceClick);
							checker = !checker;
						}
					}

					// Placeholder until FEN is passed in as part of data (data = board+FEN)
					var placeholderFEN = data;
					var completeMove = [];
					function handlePieceClick() {
						// Clear previous highlights
						const squares = document.querySelectorAll('.chessboard div');
						squares.forEach(square => square.classList.remove('highlight'));

						// Get the position of the clicked piece
						const rowIndex = Math.floor(Array.from(chessboard.children).indexOf(this) / 8);
						const colIndex = Array.from(chessboard.children).indexOf(this) % 8;

						// Display the position in the console
						console.log(`Clicked grid: row ${rowIndex}, column ${colIndex}`);
						// Composing a move
						completeMove.push(rowIndex, colIndex);

						// After selecting one grid
						if (completeMove.length == 2) {
							if (this.innerHTML == "") {
								alert("Please select a piece!");
								completeMove = [];
								return;
							} else {
								// Highlight clicked piece's square
								this.classList.add('highlight');
								console.log(`No complete move registered yet, existing selection: ${completeMove[0]}, ${completeMove[1]}`);
							}
						// When completeMove.length == 4
						} else {
							console.log("Complete move registered!");
							// Handling selection of the same piece, indicating that the user is intending to reselect
							if (completeMove[0] == completeMove[2] && completeMove[1] == completeMove[3]) {
								completeMove = [];
								this.classList.remove('highlight');
								console.log("Same piece selected, clear piece choice.")
							} else {
								// TODO: send request for FEN+move to get FEN+board in response, update display
								var requestString = placeholderFEN + completeMove[0] + completeMove[1] + completeMove[2] + completeMove[3];
								console.log(requestString);
								// fetch string will be replace by requestString
								fetch("rnbqkbnr/ppppp1pp/5p2/3P4/5P2/4P1P1/PPP4P/RNBQKBNR")
								.then(response => response.text())
								.then(data => {
									console.log(data);
									// Placeholder before getting new FEN to signal chessboard change on completed move selection:
									// TODO: parse the response data, data -> board+FEN
									pieces = getUnicodeFromBoard(data);
									while (chessboard.firstChild) {
										chessboard.firstChild.remove();
										console.log(`Cleared Chessboard`);
									}
									for (let row = 0; row < 8; row++) {
										for (let col = 0; col < 8; col++) {
											const square = document.createElement('div');
											if (col == 0) {
												checker = !checker;
											}
											if (checker) {
												square.classList.add('checker-dark');
											} else {
												square.classList.add('checker-light');
											}
											square.classList.add('piece');
											square.innerHTML = pieces[row * 8 + col];
											chessboard.appendChild(square);   
											square.addEventListener('click', handlePieceClick);
											checker = !checker;
										}
									}
								})
								.catch(error => {
									console.error('Error:', error);
								});

								completeMove = [];
							} 
						}
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
			});

		function getUnicodeFromBoard(board) {
			var pieces = [];
			for (var i = 0; i < board.length; i++) {
				var character = board.charAt(i);
				switch (character) {
					case 'P':
						console.log("Found 'P'");
						pieces.push('♙');
						break;
					case 'R':
						console.log("Found 'R'");
						pieces.push('♖');
						break;
					case 'N':
						console.log("Found 'N'");
						pieces.push('♘');
						break;
					case 'B':
						console.log("Found 'B'");
						pieces.push('♗');
						break;
					case 'Q':
						console.log("Found 'Q'");
						pieces.push('♕');
						break;
					case 'K':
						console.log("Found 'K'");
						pieces.push('♔');
						break;

					case 'p':
						console.log("Found 'p'");
						pieces.push('♟');
						break;
					case 'r':
						console.log("Found 'r'");
						pieces.push('♜');
						break;	
					case 'n':
						console.log("Found 'n'");
						pieces.push('♞');
						break;
					case 'b':
						console.log("Found 'b'");
						pieces.push('♝');
						break;
					case 'q':
						console.log("Found 'q'");
						pieces.push('♛');
						break;
					case 'k':
						console.log("Found 'k'");
						pieces.push('♚');
						break;
					case '.':
						console.log("Found '.'");
						pieces.push('');
						break;	
					case '-':
						i = board.length;
						break;
					default:
						console.log("Found other character");
						break;
				}
			}
			return pieces;
		}
    </script>
</body>
</html>
