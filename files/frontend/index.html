<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"> 
    <title>Chessboard</title>
    <style>
        .chessboard {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 400px;
            height: 400px;
        }

        .chessboard div {
            border: 1px solid black;
            cursor: pointer;
        }

		.checker-dark {
			background-color: rgba(34, 49, 4, 0.901);
		}
		.checker-light {
			background-color: rgba(89, 99, 69, 0.861);
		}

        .piece {
            font-size: 40px;
            text-align: center;
            line-height: 1;
        }

        .highlight {
            background-color: rgba(155, 179, 109, 0.816) ! !important;
        }
    </style>
</head>


<body>
	<!-- Start New Game button -->
	<button type="button" id="myButton">Start New Game</button>
	<!-- Chessboard Display -->
    <div class="chessboard"></div>

	<script>
		var btn = document.getElementById('myButton');

		btn.addEventListener('click', function() {
			fetch('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR')
				.then(response => response.text())
				.then(data => {
					console.log(data);
					// TODO: Initialize board using response data (board)
					var pieces = getUnicodeFromBoard(data);
					
					const chessboard = document.querySelector('.chessboard');
					while (chessboard.firstChild) {
						chessboard.firstChild.remove();
						console.log(`Starting new game, cleared Chessboard`);
					}

					var checker = true;
					for (let row = 0; row < 8; row++) {
						for (let col = 0; col < 8; col++) {
							const square = document.createElement('div');
							if (col == 0) {
								checker = !checker;
							}
							if (checker) {
								square.classList.add('checker-dark');
							} else {
								square.classList.add('checker-light');
							}
							square.classList.add('piece');
							square.innerHTML = pieces[row * 8 + col];
							chessboard.appendChild(square);
							square.addEventListener('click', handlePieceClick);
							checker = !checker;
						}
					}

					var completeMove = [];
					function handlePieceClick() {
						// Clear previous highlights
						const squares = document.querySelectorAll('.chessboard div');
						squares.forEach(square => square.classList.remove('highlight'));

						// Highlight clicked piece's square
						this.classList.add('highlight');

						// Get the position of the clicked piece
						const rowIndex = Math.floor(Array.from(chessboard.children).indexOf(this) / 8);
						const colIndex = Array.from(chessboard.children).indexOf(this) % 8;

						// Display the position in the console
						console.log(`Clicked piece: row ${rowIndex}, column ${colIndex}`);
						
						// Composing a move
						completeMove.push(rowIndex, colIndex);
						if (completeMove.length == 4) {
							console.log("Complete move registered!");

							// Handling selection of the same piece, indicating that the user is intending to reselect
							if (completeMove[0] == completeMove[2] && completeMove[1] == completeMove[3]) {
								completeMove = [];
								this.classList.remove('highlight');
								console.log("Same piece selected, clear piece choice.")
							} else {
								// TODO: send request for FEN+move to get FEN+board in response, update display

								// Placeholder before getting new FEN to signal chessboard change on completed move selection:
								pieces = ['', '♞', '♝', '♛', '♚', '♝', '♞', '♜',
										'♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟',
										'', '', '', '', '', '', '', '',
										'♜', '', '', '', '', '', '', '',
										'', '', '', '', '', '', '', '',
										'', '', '', '', '', '', '', '',
										'♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙',
										'♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖'];

								while (chessboard.firstChild) {
									chessboard.firstChild.remove();
									console.log(`Cleared Chessboard`);
								}

								for (let row = 0; row < 8; row++) {
									for (let col = 0; col < 8; col++) {
										const square = document.createElement('div');
										if (col == 0) {
											checker = !checker;
										}
										if (checker) {
											square.classList.add('checker-dark');
										} else {
											square.classList.add('checker-light');
										}
										square.classList.add('piece');
										square.innerHTML = pieces[row * 8 + col];
										chessboard.appendChild(square);   
										square.addEventListener('click', handlePieceClick);
										checker = !checker;
									}
								}
								completeMove = [];
							} 
						} else {
							// When completeMove.length == 2
							// TODO: Check to see if a valid piece is chosen:
							// that is, the rowPos and colPos matches a piece that belongs to the user side
							console.log(`No complete move registered yet, existing selection: ${completeMove[0]}, ${completeMove[1]}`)
						}
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
			});

		function getUnicodeFromBoard(board) {
			var pieces = [];
			for (var i = 0; i < board.length; i++) {
				var character = board.charAt(i);
				switch (character) {
					case 'P':
						console.log("Found 'P'");
						pieces.push('♙');
						break;
					case 'R':
						console.log("Found 'R'");
						pieces.push('♖');
						break;
					case 'N':
						console.log("Found 'N'");
						pieces.push('♘');
						break;
					case 'B':
						console.log("Found 'B'");
						pieces.push('♗');
						break;
					case 'Q':
						console.log("Found 'Q'");
						pieces.push('♕');
						break;
					case 'K':
						console.log("Found 'K'");
						pieces.push('♔');
						break;

					case 'p':
						console.log("Found 'p'");
						pieces.push('♟');
						break;
					case 'r':
						console.log("Found 'r'");
						pieces.push('♜');
						break;	
					case 'n':
						console.log("Found 'n'");
						pieces.push('♞');
						break;
					case 'b':
						console.log("Found 'b'");
						pieces.push('♝');
						break;
					case 'q':
						console.log("Found 'q'");
						pieces.push('♛');
						break;
					case 'k':
						console.log("Found 'k'");
						pieces.push('♚');
						break;
					case '.':
						console.log("Found '.'");
						pieces.push('');
						break;	
					case '-':
						i = board.length;
						break;
					default:
						console.log("Found other character");
						break;
				}
			}
			return pieces;
		}
    </script>
</body>
</html>
